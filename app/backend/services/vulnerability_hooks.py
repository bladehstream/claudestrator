"""
Vulnerability event hooks for triggering notifications.

Provides hook points for:
- New KEV status detection
- High EPSS score detection
- Vulnerability updates
"""

import logging
from sqlalchemy.ext.asyncio import AsyncSession

from app.database.models import Vulnerability
from app.backend.services.email_notification_service import EmailNotificationService

logger = logging.getLogger(__name__)


class VulnerabilityHooks:
    """Hooks for vulnerability events to trigger notifications."""

    def __init__(self):
        """Initialize vulnerability hooks."""
        self.email_service = EmailNotificationService()

    async def on_vulnerability_created(
        self,
        db: AsyncSession,
        vulnerability: Vulnerability
    ) -> None:
        """
        Called when a new vulnerability is created.

        Args:
            db: Database session
            vulnerability: Newly created vulnerability
        """
        logger.debug(f"Vulnerability created hook: {vulnerability.cve_id}")

        # Check if this should trigger KEV alert
        if vulnerability.kev_status:
            alert_types = ["kev"]

            # Also check for high EPSS
            if vulnerability.epss_percentile is not None:
                config = await self.email_service.get_notification_config(db)
                if config and config.alert_on_high_epss:
                    if vulnerability.epss_percentile >= config.epss_threshold:
                        alert_types.append("high_epss")

            await self.email_service.queue_alerts_for_vulnerability(
                db, vulnerability, alert_types
            )
            logger.info(f"Queued alerts for new vulnerability: {vulnerability.cve_id}")

    async def on_kev_status_updated(
        self,
        db: AsyncSession,
        vulnerability: Vulnerability,
        was_kev: bool,
        is_kev: bool
    ) -> None:
        """
        Called when KEV status is updated.

        Args:
            db: Database session
            vulnerability: Updated vulnerability
            was_kev: Previous KEV status
            is_kev: New KEV status
        """
        logger.debug(f"KEV status updated hook: {vulnerability.cve_id} ({was_kev} -> {is_kev})")

        # Alert only on NEW KEV status (wasn't KEV, now is)
        if not was_kev and is_kev:
            await self.email_service.queue_alerts_for_vulnerability(
                db, vulnerability, ["kev"]
            )
            logger.info(f"New KEV detected: {vulnerability.cve_id}, alerts queued")

    async def on_epss_score_updated(
        self,
        db: AsyncSession,
        vulnerability: Vulnerability,
        old_epss_percentile: float,
        new_epss_percentile: float
    ) -> None:
        """
        Called when EPSS score is updated.

        Args:
            db: Database session
            vulnerability: Updated vulnerability
            old_epss_percentile: Previous EPSS percentile
            new_epss_percentile: New EPSS percentile
        """
        logger.debug(
            f"EPSS updated hook: {vulnerability.cve_id} "
            f"({old_epss_percentile} -> {new_epss_percentile})"
        )

        config = await self.email_service.get_notification_config(db)
        if not config or not config.alert_on_high_epss:
            return

        # Alert if score crossed threshold
        was_high = old_epss_percentile is not None and old_epss_percentile >= config.epss_threshold
        is_high = new_epss_percentile >= config.epss_threshold

        if not was_high and is_high:
            await self.email_service.queue_alerts_for_vulnerability(
                db, vulnerability, ["high_epss"]
            )
            logger.info(
                f"High EPSS detected: {vulnerability.cve_id} "
                f"({new_epss_percentile:.2%}), alerts queued"
            )


# Global hooks instance
_vulnerability_hooks: VulnerabilityHooks = None


def get_vulnerability_hooks() -> VulnerabilityHooks:
    """Get or create global vulnerability hooks instance."""
    global _vulnerability_hooks
    if _vulnerability_hooks is None:
        _vulnerability_hooks = VulnerabilityHooks()
    return _vulnerability_hooks
